# ロボット-コンソール間通信プロトコル

ロボット-コンソール間は, byte配列でやり取りされる.  
送るbyte配列の形式を次に示す.

## プロトコル概観

送受信するデータ型によって, 次のように各バイトの表す意味が異なる.

「データ種別」「データのbyte表現」の共通説明は, 次章に述べる.

### 真偽値, 整数, 不動小数点数, 文字を送受信する場合
対象のデータ型 : boolean, byte, short, int, long, ushort, uint, ulong, char, float, double

| 1バイト目 | 2バイト目以降 |
| --- | --- |
| データ種別(0x01-0x0B) | データのbyte表現 |

### 文字列を送受信する場合
対象のデータ型 : string

| 1バイト目 | 2バイト目 | 3バイト目以降 |
| --- | --- | --- |
| データ種別(0x0C) | 文字列長(0x00-0xFF) | 文字列データのbyte表現 |

* 文字列は, ASCIIエンコーディングされて送受信される.

  ASCII(0x00-0x7F)で表すことのできない文字(拡張ASCIIやマルチバイト文字)は送受信することができない.
  文字列長は, 各文字をASCII文字と見たときの文字列長である.

### 配列を送受信する場合
対象のデータ型 : boolean, byte, short, int, long, ushort, uint, ulong, char, float, double の配列

(stringの配列や, 配列の配列は送受信できない.)

| 1バイト目 | 2バイト目 | 3バイト目 | 4バイト目以降 |
| --- | --- | --- | --- |
| データ種別(0x0D) | 配列の要素数(0x01～0xFF) | 配列要素のデータ種別(0x01～0x0B) | 各要素のデータのbyte表現 |

* 4バイト目以降は, 配列の各要素のデータのbyte表現が, 配列の要素数分だけ連続する.

* 配列の要素数に0x00を指定することは禁止とする.

## データ種別

送受信するデータの型を表す.

数値 | 表すデータ型
--- | ---
0x00 | 使用禁止
0x01 | boolean
0x02 | byte
0x03 | short
0x04 | int
0x05 | long
0x06 | ushort
0x07 | uint
0x08 | ulong
0x09 | char
0x0A | float
0x0B | double
0x0C | string
0x0D | 配列
0x0E～0xFF | 使用禁止

## データのbyte表現

* データのbyte表現は, 「データをbyte型にキャストしたもの」ではなく, データをそのままbyte配列に変換したものである.

  両者の違いは, たとえば,

  * 0x01234567(int型)をbyte型にキャスト : 0x01234567 → 0x67
  * 0x01234567(int型)をbyte配列に変換 : 0x01234567 → { 0x67, 0x45, 0x23, 0x01 }

  となる(リトルエンディアンの場合). キャストでは, 丸めや切捨てが発生してしまう.

* データのbyte表現は, リトルエンディアンとする.

  * EV3は値をリトルエンディアンで扱うため, リトルエンディアンで通信することで, EV3上でのエンディアン変換処理をしなくてすむ.

